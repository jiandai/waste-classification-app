<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#111827" />
  <meta name="description" content="AI-powered waste classification - determine which bin your waste items belong to" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Bin Classifier" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <title>Waste Bin Classifier</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #f6f7f9; 
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    header { 
      padding: 20px; 
      background: #fff; 
      border-bottom: 1px solid #e6e8ec; 
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header strong {
      font-size: 18px;
    }
    main { 
      max-width: 100%; 
      margin: 0 auto; 
      padding: 16px; 
    }
    @media (min-width: 768px) {
      main {
        max-width: 720px;
      }
    }
    .card { 
      background: #fff; 
      border: 1px solid #e6e8ec; 
      border-radius: 12px; 
      padding: 20px; 
      margin: 12px 0; 
    }
    .row { 
      display: flex; 
      gap: 12px; 
      flex-wrap: wrap; 
      align-items: center; 
    }
    button { 
      padding: 16px 24px; 
      border-radius: 12px; 
      border: 2px solid #d0d5dd; 
      background: #fff; 
      cursor: pointer; 
      font-size: 16px;
      font-weight: 600;
      min-height: 48px;
      min-width: 120px;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    button:active {
      transform: scale(0.98);
    }
    button.primary { 
      background: #111827; 
      color: #fff; 
      border-color: #111827; 
    }
    button.primary:active {
      background: #374151;
    }
    button:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
      transform: none;
    }
    .badge { 
      display: inline-block; 
      padding: 8px 14px; 
      border-radius: 999px; 
      border: 2px solid #d0d5dd; 
      font-weight: 600; 
      font-size: 14px;
    }
    .muted { 
      color: #667085; 
      font-size: 14px; 
      line-height: 1.5;
    }
    img.preview { 
      max-width: 100%; 
      border-radius: 10px; 
      border: 1px solid #e6e8ec; 
      display: block;
    }
    pre { 
      white-space: pre-wrap; 
      word-break: break-word; 
      background: #0b1220; 
      color: #e5e7eb; 
      padding: 12px; 
      border-radius: 10px; 
      overflow: auto; 
      font-size: 12px;
      max-height: 400px;
    }
    .spinner { 
      display: none; 
      font-weight: 600;
      color: #111827;
    }
    .spinner.show { 
      display: flex; 
      align-items: center;
      gap: 8px;
    }
    .spinner.show::before {
      content: "";
      width: 20px;
      height: 20px;
      border: 3px solid #e5e7eb;
      border-top-color: #111827;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    input[type="file"] {
      font-size: 16px;
      padding: 12px;
      border: 2px dashed #d0d5dd;
      border-radius: 12px;
      background: #f9fafb;
      cursor: pointer;
      width: 100%;
      max-width: 100%;
    }
    input[type="file"]::file-selector-button {
      padding: 12px 20px;
      border: none;
      background: #f3f4f6;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 12px;
    }
    h2, h3 {
      margin-top: 0;
      font-size: 20px;
    }
    ul {
      padding-left: 20px;
    }
    li {
      margin: 8px 0;
      line-height: 1.5;
    }
    #installBtn {
      display: none;
      margin-left: auto;
      font-size: 14px;
      padding: 10px 16px;
      min-width: auto;
    }
    header > div {
      display: flex;
      align-items: center;
      gap: 12px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div>
        <strong>Waste Bin Classifier</strong>
        <div class="muted">Upload a photo to get bin recommendations</div>
      </div>
      <button id="installBtn" class="primary">Install App</button>
    </div>
  </header>

  <main>
    <div class="card">
      <h2 style="margin-top:0;">Which bin should this go in?</h2>
      <div class="muted">Take a clear photo of one item. Works best in good lighting.</div>
      <div style="height:16px;"></div>

      <div>
        <input id="file" type="file" accept="image/*" capture="environment" />
      </div>
      <div style="height:12px;"></div>
      <div class="row">
        <button id="btnUpload" class="primary" disabled>Analyze Photo</button>
        <span id="spin" class="spinner">Analyzing…</span>
      </div>

      <div style="height:16px;"></div>
      <div id="previewWrap" style="display:none;">
        <img id="preview" class="preview" alt="preview" />
      </div>
    </div>

    <div id="resultCard" class="card" style="display:none;">
      <h3 style="margin-top:0;">Result</h3>
      <div id="binLine"></div>
      <ul id="rationale"></ul>

      <div id="clarifyWrap" style="display:none;">
        <hr />
        <div class="muted" style="margin-bottom:8px;">Clarification needed:</div>
        <div id="clarifyQ" style="font-weight:600;margin-bottom:10px;"></div>
        <div class="row">
          <button id="btnYes">Yes</button>
          <button id="btnNo">No</button>
        </div>
      </div>
    </div>

    <div id="debugCard" class="card" style="display:none;">
      <h3 style="margin-top:0;">Debug (raw JSON)</h3>
      <pre id="debug"></pre>
    </div>
  </main>

<script>
  // Service worker registration for PWA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').then(
        registration => console.log('ServiceWorker registered:', registration.scope),
        err => console.log('ServiceWorker registration failed:', err)
      ).catch(err => console.log('ServiceWorker error:', err));
    });
  }

  // Handle install prompt
  let deferredPrompt;
  const installBtn = document.getElementById('installBtn');
  
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // Show install button when prompt is available
    installBtn.style.display = 'block';
    console.log('Install prompt available');
  });
  
  // Handle install button click
  installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    
    // Show the install prompt
    deferredPrompt.prompt();
    
    // Wait for user response
    const { outcome } = await deferredPrompt.userChoice;
    console.log('User response to install prompt:', outcome);
    
    // Clear the deferred prompt
    deferredPrompt = null;
    installBtn.style.display = 'none';
  });
  
  // Hide install button if app is already installed
  window.addEventListener('appinstalled', () => {
    deferredPrompt = null;
    installBtn.style.display = 'none';
    console.log('PWA installed');
  });

  function getApiBase() {
    // Allow overriding in the URL for quick testing, e.g.
    //   http://10.0.0.230:8080/?apiBase=http://10.0.0.230:8000
    const params = new URLSearchParams(window.location.search);
    const override = params.get("apiBase");
    if (override) return override.replace(/\/+$/, "");

    // Default to current origin (same host and port) for unified deployment
    return window.location.origin;
  }

  const API_BASE = getApiBase();
  const fileEl = document.getElementById("file");
  const btnUpload = document.getElementById("btnUpload");
  const spin = document.getElementById("spin");
  const previewWrap = document.getElementById("previewWrap");
  const previewImg = document.getElementById("preview");

  const resultCard = document.getElementById("resultCard");
  const binLine = document.getElementById("binLine");
  const rationaleUl = document.getElementById("rationale");
  const clarifyWrap = document.getElementById("clarifyWrap");
  const clarifyQ = document.getElementById("clarifyQ");
  const btnYes = document.getElementById("btnYes");
  const btnNo = document.getElementById("btnNo");

  const debugCard = document.getElementById("debugCard");
  const debugPre = document.getElementById("debug");

  let lastResponse = null;

  function setLoading(isLoading) {
    btnUpload.disabled = isLoading || !fileEl.files?.length;
    spin.className = isLoading ? "spinner show" : "spinner";
  }

  fileEl.addEventListener("change", () => {
    const file = fileEl.files[0];
    btnUpload.disabled = !file;
    if (!file) return;

    // Preview
    const url = URL.createObjectURL(file);
    previewImg.src = url;
    previewWrap.style.display = "block";

    // Reset results
    resultCard.style.display = "none";
    debugCard.style.display = "none";
    lastResponse = null;
  });

  btnUpload.addEventListener("click", async () => {
    const file = fileEl.files[0];
    if (!file) return;

    setLoading(true);
    
    // Create abort controller for timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
    
    try {
      const form = new FormData();
      form.append("image", file);
      form.append("jurisdiction_id", "CA_DEFAULT");
      //form.append("client_request_id", crypto.randomUUID());

      const res = await fetch(`${API_BASE}/v1/classify`, { 
        method: "POST", 
        body: form,
        signal: controller.signal
      });
      
      const json = await res.json();
      clearTimeout(timeoutId);
      lastResponse = json;

      renderResponse(json, res.ok ? null : `HTTP ${res.status}`);
    } catch (e) {
      clearTimeout(timeoutId);
      if (e.name === 'AbortError') {
        renderError('Request timed out. Please check your connection and try again.');
      } else {
        renderError(String(e));
      }
    } finally {
      setLoading(false);
    }
  });

  btnYes.addEventListener("click", () => submitClarification(true));
  btnNo.addEventListener("click", () => submitClarification(false));

  async function submitClarification(answer) {
    if (!lastResponse?.clarification) return;

    setLoading(true);
    
    // Create abort controller for timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
    
    try {
      const payload = {
        request_id: lastResponse.request_id,
        question_id: lastResponse.clarification.question_id,
        answer,
        top_labels: lastResponse.result?.top_labels || []
      };

      const res = await fetch(`${API_BASE}/v1/clarify`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        signal: controller.signal
      });

      const json = await res.json();
      clearTimeout(timeoutId);
      lastResponse = json;
      renderResponse(json, res.ok ? null : `HTTP ${res.status}`);
    } catch (e) {
      clearTimeout(timeoutId);
      if (e.name === 'AbortError') {
        renderError('Request timed out. Please check your connection and try again.');
      } else {
        renderError(String(e));
      }
    } finally {
      setLoading(false);
    }
  }

  function renderError(msg) {
    resultCard.style.display = "block";
    binLine.innerHTML = `<span class="badge">ERROR</span> <span class="muted">${escapeHtml(msg)}</span>`;
    rationaleUl.innerHTML = "";
    clarifyWrap.style.display = "none";
    debugCard.style.display = "none";
  }

  function renderResponse(json, httpError) {
    resultCard.style.display = "block";
    debugCard.style.display = "block";
    debugPre.textContent = JSON.stringify(json, null, 2);

    if (httpError) {
      binLine.innerHTML = `<span class="badge">ERROR</span> <span class="muted">${escapeHtml(httpError)}</span>`;
      rationaleUl.innerHTML = `<li class="muted">${escapeHtml(json?.error?.message || "Request failed")}</li>`;
      clarifyWrap.style.display = "none";
      return;
    }

    const r = json.result;
    binLine.innerHTML = `<span class="badge">${escapeHtml(r.bin)}</span> <strong>${escapeHtml(r.bin_label)}</strong>
      <span class="muted"> — Confidence: ${escapeHtml(r.confidence)} (${Number(r.confidence_score).toFixed(2)})</span>`;

    rationaleUl.innerHTML = "";
    (r.rationale || []).forEach(item => {
      const li = document.createElement("li");
      li.textContent = `${item.type}: ${item.text}`;
      rationaleUl.appendChild(li);
    });

    if (json.needs_clarification && json.clarification) {
      clarifyWrap.style.display = "block";
      clarifyQ.textContent = json.clarification.question_text;
    } else {
      clarifyWrap.style.display = "none";
    }
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }
</script>
</body>
</html>

